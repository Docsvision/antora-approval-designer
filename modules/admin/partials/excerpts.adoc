// tag::hierarchy[]
На результат завершения этапа влияет последовательность семантик. Первая обнаруженная семантика из следующего списка будет считаться результатом завершения этапа: menu:Завершение[Новый цикл > Отмена > Отрицательно > Нейтрально (Условно-положительно) > Переход A > Переход B > Переход C > Переход D > Переход E > Положительно].

NOTE: Семантики _Переход A_, _Переход B_, _Переход C_, _Переход D_, _Переход E_ доступны только для _Усовершенствованного согласования_.
// end::hierarchy[]

// tag::collection[]
Если указать сразу несколько способов определения согласующих, например _Поле документа_ и указать конкретного согласующего, согласующие будут определены по совокупности этих полей.
// end::collection[]

// tag::advanced-update[]
[NOTE]
====
Перед обновлением модуля {ad}, работающим с обычным согласованием, рекомендуется оставить только один используемый вариант и очистить значения неиспользуемых.
====
// end::advanced-update[]

// tag::crmodes[]
Для усовершенствованного согласования в справочнике видов карточек по умолчанию доступен только один xref:6.1@backoffice:desdirs:card-kinds/card-create-mode.adoc[режим создания]. Если раньше каждому виду карточки соответствовал свой режим создания, то сейчас логика привязки маршрута к виду встроена в настройках карточки согласования _Усовершенствованное согласование_. Эта карточка находится в новой корневой папке _Усовершенствованное согласование_.
// end::crmodes[]

// tag::start-cond[]
Условия старта можно задать для любого этапа, включая первый. Первый этап стартует при выполнении условия на втором и последующих проходах или циклах. При начальном запуске согласования это условие учитываться не будет.
// end::start-cond[]

//tag::manual-delete[]
После обновления модуля с версии 5.5.2 и старше необходимо вручную в _Справочнике видов карточек_ удалить xref:6.1@backoffice:desdirs:card-kinds/card-create-mode.adoc[режимы создания] из карточки _Согласование КС_. Это необходимо, чтобы у пользователя не отображались одновременно старое согласование через бизнес-процессы и усовершенствованное согласование.
//end::manual-delete[]

//tag::save-stage[]
WARNING: Маршрут не может быть сохранён, если не указан первый этап.
//end::save-stage[]

//tag::repeat[]
* *_Никогда_* -- этап не будет повторяться внутри цикла ни при каких условиях.
* *_Всегда_* -- этап будет повторяться в соответствии с логикой усовершенствованного согласования. Значение используется по умолчанию.
* *_Для отказавших_* -- при повторе этапа задания отправляются только участникам, которые не согласовали. Будут учтены результаты последнего экземпляра этого этапа.
+
Если в предыдущий раз отрицательных решений не было, то этап будет пропущен в соответствии с логикой усовершенствованного согласования.
+
* *_Если был завершён отрицательно_* -- этап повторяется, только если в предыдущий раз он завершился с отрицательной семантикой. Задания будут отправлены всем согласующим и учтены результаты последнего экземпляра этого этапа. +
Если в предыдущий раз этап завершился положительно или условно-положительно, он будет пропущен в соответствии с логикой усовершенствованного согласования.
* *_Для отказавших или всем при изменении файла на следующих этапах_*. Считается, что файл менялся, когда исходная версия текущего и предыдущего экземпляра этапа отличаются.
+
.В таком случае задания будут рассылаться:
** Только согласующим, принявшим отрицательное решение.
** Всем согласующим, если файлы менялись.
//end::repeat[]

//tag::multiple[]
Если один сотрудник участвовал в согласовании несколько раз, в листе согласования будет отображаться только его последнее решение. Остальные решения этого сотрудника отображены не будут.
//end::multiple[]

//tag::decisions[]
* _Положительное_: *_Согласовать_*, *_Утвердить_*.
* _Условно-положительное_: *_Согласовать с замечаниями_*.
* _Отрицательное_: *_Не утвердить_*, *_Отказать_*.
* _Новый цикл_ -- запуск нового цикла согласования (повторный старт маршрута).
ifndef::approvers[]
* *_Добавление согласующих_* -- возможность добавить новых согласующих в цикл согласования.
endif::[]
* _Отмена_ -- отмена текущего согласования с отзывом всех заданий, например, *_Вернуть на подготовку_*.
* _Завершение_ -- окончание процесса согласования, когда документ прошел все этапы процесса -- _Согласован_, _Подписан_, _Зарегистрирован_ и прочие. Например, *_Зарегистрировать_*.
+
include::partial$excerpts.adoc[tags=transfers-only]
//end::decisions[]

// tag::enum[]
Варианты только для усовершенствованного согласования: *_Переход A_*, *_Переход B_*, *_Переход C_*, *_Переход D_*, *_Переход E_*.
// end::enum[]

//tag::result[]
// tag::options[]
* *_Положительное_* -- положительное решение по согласованию. При выборе данного варианта задание будет завершено. Примеры положительных решений: *Согласовать*, *Подписать*, *Утвердить*.
* *_Условно-положительное_* -- положительное решение по согласованию с возможностью ввода комментария. При выборе данного варианта у пользователя появится окно ввода текстового комментария. После ввода комментария задание будет завершено. Примеры условно-положительных решений: *Согласовать с замечаниями*, *Подписать с комментарием*.
* *_Отрицательное_* -- отрицательное решение по согласованию с возможностью ввода комментария. При выборе данного варианта у пользователя появится окно для ввода текстового комментария. После ввода комментария задание будет завершено. Примеры отрицательных решений: *Не утвердить*, *Не согласовано*, *Отказать*.
* *_Отмена_* -- отмена согласования с возможностью ввода комментария. При выборе данного варианта у пользователя появится окно для ввода текстового комментария. После ввода комментария согласование будет отменено. Например, *Отменить согласование*.
* *_Новый цикл_* -- отправка документа на повторное согласование с возможностью ввода комментария. При выборе данного варианта у пользователя появится окно для ввода текстового комментария. После ввода комментария будет запущен новый цикл согласования. Например, *Повторить согласование*.
* *_Добавление согласующих_* -- выбор дополнительных согласующих с возможностью ввода комментария. При выборе данного варианта у пользователя появится окно для ввода текстового комментария и указания дополнительных согласующих. Например, *Дополнительное согласование*.
+
После выбора дополнительных согласующих, в зависимости от настроек, данным сотрудникам будет отправлено задание на согласование, либо предварительно будет отправлено задание инициатору для утверждения новых участников.
+
* *_Завершение_* -- завершение всего процесса согласования. При выборе данного варианта процесс согласования будет принудительно завершен. Например, *Зарегистрировать*.
* *_Возврат на предыдущий этап_* -- вариант, доступный только для усовершенствованного согласования, позволяет вернуть согласование на предыдущий этап, чтобы повторить его в текущем цикле. При возвращении на предыдущий этап будет предложено ввести комментарий (можно пропустить).
+
При возврате задания на предыдущий этап в _Содержание_ задания (_Описание_ при работе в {wc}е) автоматически будет добавлена строка с информацией об этом.
// tag::transfers[]
// tag::transfers-only[]
* Для усовершенствованных маршрутов предусмотрены дополнительные семантики завершения согласования:
** Переход A
** Переход B
** Переход C
** Переход D
** Переход E
// end::transfers-only[]
+
****
.Дополнительные семантики можно выбрать:
. В карточке этапа при настройке вариантов завершения задания.
. В карточке маршрута при настройке условий старта этапа.
. При настройке условий завершения маршрута.

При автоматическом завершении согласования новые семантики учитываются как нейтральные.

Вычисление результата завершения этапа происходит по правилам, описанным в разделе "xref:approval-finish-rules.adoc#semantics[Семантика завершения этапа]".
****
// end::transfers[]

// end::options[]
+
. В поле _Иконка_ укажите изображение, которое будет отображаться на кнопке принятия решения в ленте карточки. Чтобы выбрать файл, нажмите кнопку *Изменить*, затем выберите файл.
+
Рекомендуется использовать формат `.png`. Размеры иконок должны быть 16x16 либо 32x32 px. Изображения большего размера будут автоматически обрезаны до 32x32 px.
+
. Установите флаг `*Запрашивать электронную подпись*`, если при принятии решения должна быть подписана версия файла.
//end::result[]

//tag::apply[]
Изменения будут применены для всех этапов, кроме запущенных.
//end::apply[]

//tag::stage[]
****
Любой этап может повторяться многократно, если не выполнено условие старта следующего этапа.

Если в ходе согласования сложилась ситуация, что нет этапов, для которых сработало условие старта, система автоматически проверит последние сработавшие экземпляры этапов в текущем цикле.

Если среди сработавших этапов нет завершённых отрицательно, согласование автоматически завершается и документ будет считаться согласованным.

Если завершённые отрицательно этапы имеются, автоматически запустится новый цикл согласования.
****
//end::stage[]