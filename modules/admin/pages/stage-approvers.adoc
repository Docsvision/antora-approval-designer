= Выбор согласующих

Состав согласующих может определяться различными способами. Количество доступных способов зависит от вида используемого согласования -- {us} предоставляет больше способов выбора согласующих.

.Чтобы определить список согласующих:
. Создайте новую или откройте существующую карточку этапа.
. Перейдите на вкладку _Параметры этапа_.
. Определите способ выбора согласующих.

== Обычное согласование

.В обычном согласовании согласующих можно назначить следующими способами:
* <<manual-select,Напрямую>> выбрать из _Справочника сотрудников_.
* <<card-field,Автоматически>> вычислить из определённого поля карточки _Документ_.
* <<business-process,Вычислить>> при помощи стороннего бизнес-процесса.

В обычном согласовании может использоваться только один из доступных вариантов выбора согласующих. Если выбраны несколько способов, будет использован только один.

Настройки усовершенствованного согласования не поддерживаются в обычном.

.При обычном согласовании согласующие определяются по следующей логике:
* Если задан БП, используется его логика.
* Если БП не задан, согласующий выбирается из поля (если поле заполнено).
* В остальных случаях согласующий будет выбран из списка согласующих в этапе.

== {us}

.В усовершенствованном согласовании согласующих можно назначить следующими способами:
* <<manual-select,Напрямую>> выбрать из _Справочника сотрудников_.
* <<card-field,Автоматически>> вычислить из определённого поля карточки _Документ_.
* Для усовершенствованного согласования также доступна вкладка _Специальная логика этапа_, на которой можно <<custom-service,указать {service}>>.

Если в обычном согласовании можно было указать только один способ определения согласующих, в усовершенствованном согласовании поддерживается определение согласующих сразу несколькими способами.

include::partial$excerpts.adoc[tags=collection]

Вычисление согласующих при помощи бизнес-процессов не поддерживается в усовершенствованном согласовании.

[#manual-select]
== Выбор сотрудников вручную

.Если предполагается явно выбирать сотрудников из Справочника сотрудников:
. Выберите согласующих в поле выбора согласующих.
+
.Выбор согласующих из "Справочника сотрудников"
image::approvers.png[Выбор согласующих из "Справочника сотрудников"]

.В качестве согласующих могут быть выбраны следующие значения из "Справочника сотрудников":
* Сотрудник.
* Организация или подразделение.
* Группа.
* Роль.
* Последние использованные значения -- одно из введённых ранее значений.
* Поисковые слова:
+
--
Руководитель инициатора::
Будет найден руководитель, указанный в карточке сотрудника-инициатора согласования. Если руководитель не указан в карточке сотрудника, будет поиск продолжается, будет выбран руководитель подразделения, в котором состоит сотрудник. Если в подразделении, в котором состоит сотрудник руководитель не указан, то ищем руководителя подразделения, находящегося выше по иерархии. Поиск продолжается выше по иерархии, пока не находится руководитель. Как только руководитель находится, он записывается в поле карточки, и поиск прекращается.
+
[[hierarchy]]В поле _Уровень иерархии_ укажите целое числовое значение, обозначающее уровень в иерархии.
+
Порядок определяется снизу вверх. Например, уровень непосредственного руководителя -- `1`. Если указан уровень иерархии `2`, поиск выполняется сразу по руководителю подразделения, в котором состоит сотрудник.
Если у подразделения, в котором состоит сотрудник не указан руководитель, то поиск продолжается по иерархии. Найденные руководители не суммируются.
+
Все руководители инициатора::
Будут найдены сотрудники, которые указаны в _Справочнике сотрудников_ как непосредственные и вышестоящие руководители сотрудника-инициатора согласования.
+
Инициатор::
Будет указан сотрудник, который создал согласование из карточки _Документ_.
+
Регистратор::
Будет указан сотрудник, который создал карточку вида _Документ УД_, и зарегистрировал документ в системе {dv}.
--

[#card-field]
== Выбор сотрудников из поля карточки документа

.Если предполагается указывать сотрудников из определённого поля в структуре карточки:
. Выберите _Документ_, поле или секцию карточки, из которого следует загружать данные о сотрудниках, в _Поле документа_.
+
[WARNING]
====
Выбирать можно также динамические поля и секции. После создания данных полей в _Конструкторе разметок_, перезапустите сервис _Workflow_, чтобы бизнес-процессы работали корректно.
====

[#business-process]
== Выбор сотрудников бизнес-процессом

WARNING: Вычисление согласующих при помощи бизнес-процессов не поддерживается в усовершенствованном согласовании. Если другие способы не заданы, согласующие не будут определены.

.Если предполагается использовать бизнес-процесс для поиска сотрудников:
. В поле _Бизнес-процесс_ выберите шаблон бизнес-процесса, который должен быть запущен при старте этапа.
+
****
Процесс должен возвращать коллекцию сотрудников. Для этапа с данным типом вычисления согласующих, поле _Состав маршрута_ будет всегда пустым. Состав согласующих будет определён в ходе согласования.

Чтобы передавать и получать переменные из процесса, который определён как источник согласующих, в этом процессе необходимо создать набор переменных. Данные переменные должны совпадать по имени и типу с переменными в родительском процессе. В зависимости от типа маршрутизации этапа это будет или _КС Подпроцесс параллельное согласование_ или _КС Подпроцесс последовательное согласование_.

В подключаемом бизнес-процессе должна быть настроена переменная-коллекция типа _Сотрудник DV_ с названием _Согласующие_. Именно в неё будут записаны вычисленные процессом сотрудники. Чтобы стало возможным передавать значения переменных из родительских процессов, в настройках переменной необходимо нажать кнопку *Дополнительно* и в открывшемся окне снять флаг `*Скрыта от родительского процесса*`.

_КС Подпроцесс параллельное согласование_ или _КС Подпроцесс последовательное согласование_ передают значения, определённые в настройках переменных в подпроцесс определения согласующих. Значения переменных передаются в момент создания экземпляра подпроцесса.

По окончании работы подпроцесса значения всех его переменных, соответствующие переменным родительского процесса, будут возвращены в переменные процессов _КС Подпроцесс параллельное согласование_ или _КС Подпроцесс последовательное согласование_.
****

[#custom-service]
== Выбор сотрудников при помощи {of-service}

{c-service} может переопределять или дополнять логику этапа. Использование сервиса настраивается на вкладке _Специальная логика этапа_.

WARNING: Использование {of-service} не поддерживается в обычном согласовании.

.{c-service} позволяет:
* Определить согласующих этапа.
* Задать дополнительные параметры заданий этапа (указать контролёра, определить сроки, текст заданий и прочее).
* Выполнить определённые действия в любой момент этапа:
** До запуска.
** При запуске или завершении заданий.
** При завершении этапа.

Если указан {service}, для таких этапов будет работать определённая в данном сервисе логика. При определении согласующих можно вычислять согласующих при старте согласования либо перед стартом этапа. В первом случае согласующие записываются при создании экземпляра этапа и будут отображаться в настройках этапа в маршруте при старте и управлении согласованием.

.Чтобы указать {service}:
. Создайте собственный {service} в формате `.dll` можно с помощью Visual Studio актуальной версии.
. В карточке этапа перейдите на вкладку _Специальная логика этапа_.
. В области _{c-service}_ найдите поле _Имя сервиса_ и нажмите на кнопку image:buttons/three-dots.png[Три точки].
. Выберите из файловой системы файл `.dll`, содержащий {service}.
. При необходимости добавьте комментарий для сервиса.
. Если планируется использовать {service} для усовершенствованного согласования в {wc}е, сборку сервиса необходимо добавлять в каталог {wc}а и каталог Службы {ws}.
. Если {service} используется в {wincl}е, необходимо распространить сборку на компьютеры пользователей с помощью xref:dev@platform:desdirs:components/directory.adoc[Справочника компонентов] или групповых политик.

Методы, обрабатывающие {service}, содержатся в классах xref:programmer:ApprovalDesigner:ObjectModel/Services/ApprovalStageEventHandlerService_CL.adoc[ApprovalStageEventHandlerService] и xref:programmer:ApprovalDesigner:ObjectModel/Services/ApprovalStageService_CL.adoc[ApprovalStageService].
