= Правила завершения согласований

В рамках каждого этапа процесса согласования формируется некоторое количество заданий. Каждое задание может быть завершено одним из возможных способов, определённых семантикой решения. Результат завершения этапа будет вычисляться исходя из решений, вынесенных согласующими в заданиях на согласование.

.Пример процесса согласования
image::route-finish-process.png[Пример процесса согласования]

В данной версии модуля _Конструктора согласований_ предусмотрены следующие xref:task-decisions.adoc[варианты решений], которые могут быть приняты согласующими:

:approvers:
include::partial$excerpts.adoc[tags=decisions]

[#stage]
== Правила завершения этапов

* Этап завершается _Положительно_, если все входящие в него задания завершились с семантикой _Положительное_.
* Этап завершается _Условно-положительно_, если задания завершились с семантикой _Положительное_ и _Условно-положительное_.
* Этап завершается _Отрицательно_, если хотя бы одно задание завершено с семантикой _Отрицательное_.
* Как только задание на этапе завершается с результатом _Новый цикл_, все задания, не завершённые на этом этапе (если такие ещё есть) отзываются, стартует _Новый цикл_ согласования.
* Если задание на каком-либо этапе завершается с семантикой _Отмена_, задания КС отзываются, согласование аннулируется, а согласуемый документ возвращается в состояние `Подготовка`.
* Если задание завершается с семантикой _Завершение_, завершается целиком весь процесс согласования, документ переводится в финальное состояние, определённое в настройках карточки _Маршрут согласования_.

[#stage-finish]
include::partial$excerpts.adoc[tags=stage]

.Этап может быть завершён принудительно:
* Инициатором из карточки открытого согласования, командой _Прекратить текущий этап_, см. xref:user:approval-force-finish-stage.adoc[].
* Одним из согласующих, если настройка "xref:stage-finish-settings.adoc[При первом отказе]" установлена в значение _Завершить этап_.
+
[NOTE]
====
В некоторых случаях, для завершения этапа может использоваться семантика, xref:stage-finish-settings.adoc[заданная по умолчанию] и другие настройки. Например, семантика будет применена, если в настройках этапа не были заданы согласующие.
====

[#classic]
== Правила завершения обычного маршрута

* Маршрут завершается _Автоматически_, если положительно завершились все его этапы.
* При завершении маршрута согласование перейдёт на новый цикл, если один из этапов завершился условно-положительно и после данного этапа не было консолидации.

.Маршрут может быть завершён _Принудительно_:
* _Инициатором_ из карточки Согласования.
* Пользователем из карточки задания на согласование при выборе варианта решения с xref:task-decisions.adoc[семантикой] _Завершение_.
* Одним из согласующих, если настройка "xref:stage-finish-settings.adoc[При первом отказе]" установлена в значение _Завершить согласование_.

[#improved]
== Правила завершения усовершенствованного маршрута

Новые настройки xref:route-create.adoc#improved[усовершенствованного] маршрута игнорируются для старых маршрутов, маршрут завершается автоматически по прежней логике.

.В новом усовершенствованном согласовании настройки учитываются следующим образом:
* Если не указаны условия ни для положительного ни для отрицательного итога, согласование может быть завершено только автоматически (см. <<stage-finish,Правила завершения этапов>>).
* Если задано хотя бы одно из условий завершения, то согласование завершится сразу при наступлении этого условия.
* В зависимости от того положительное или отрицательное условие сработает, будет определено состояние согласуемого документа из соответствующей колонки таблицы _Настроек итоговых состояний документов_.
* Если одновременно сработали условия и для отрицательного и для положительного завершения, то маршрут завершается _Отрицательно_.
* При срабатывании условия завершения маршрута могут остаться незавершённые этапы и соответственно незаврешенные задания. Все эти задания автоматически будут отозваны при завершении маршрута.

// Для усовершенствованных маршрутов предусмотрены дополнительные семантики завершения согласования:
//
// * Переход A
// * Переход B
// * Переход C
// * Переход D
// * Переход E
//
// .Дополнительные семантики можно выбрать:
// . В карточке этапа при настройке вариантов завершения задания.
// . В карточке маршрута при настройке условий старта этапа.
// . При настройке условий завершения маршрута.
//
// В случае вычисления старта этапа или условия завершения маршрута семантики учитываются при явном указании. Данные семантики подразумеваются при выборе решений *_Не отрицательное_* и *_Любое_*.
//
// В случае вычисления результата завершения этапа, последовательно проверяются семантики результатов завершения всех согласующих. Если был хотя бы один результат с указанной семантикой, результатом этапа считается эта семантика.
//
// При автоматическом завершении согласования новые семантики учитываются как нейтральные.
